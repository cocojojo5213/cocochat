<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Chat Streaming Demo (Fixed)</title>

<style>
:root {
  --bg:#0f1217; --panel:#151a21; --panel-2:#1b222c;
  --text:#e5e7eb; --muted:#a0a9b8; --accent:#6ea8fe;
  --code-bg:#0b0e13; --border:#243041;
  --safe-top: env(safe-area-inset-top);
  --safe-bottom: env(safe-area-inset-bottom);
}

*{box-sizing:border-box;}
html{-webkit-text-size-adjust:100%;}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 ui-sans-serif,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
a,button{-webkit-tap-highlight-color:transparent;}
input,textarea,select{background:var(--panel);border:1px solid var(--border);color:var(--text);border-radius:8px;padding:8px 10px;outline:none;font-size:16px;}

.app{
  display:grid;
  grid-template-rows:auto 1fr auto;
  min-height:100dvh; /* iOS18 ç­‰ç°ä»£è®¾å¤‡ */
  min-height:100vh;  /* å›é€€ */
  max-width:1100px;
  margin:0 auto;
}

header{
  padding:calc(10px + var(--safe-top)) 16px 10px;
  border-bottom:1px solid var(--border);
  background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);
  display:flex;gap:12px;align-items:center;flex-wrap:wrap;
}
header .title{font-weight:700;}
header .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
label{color:var(--muted);font-size:12px;}
.grow{flex:1 1 auto;min-width:200px;}
.system-box{width:100%;min-height:60px;resize:vertical;}

.chat{
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
  overscroll-behavior:contain;
  padding:10px 16px 12px;
}

.msg{display:flex;gap:10px;margin:14px 0;align-items:flex-start;}
.msg .avatar{width:28px;height:28px;border-radius:6px;background:var(--panel-2);display:grid;place-items:center;font-size:13px;color:var(--muted);flex:0 0 28px;}
.msg.user .avatar{background:#213147;color:#b9d2ff;}
.msg.assistant .avatar{background:#1f2c22;color:#a5f3c6;}
.bubble{background:var(--panel);border:1px solid var(--border);padding:12px 14px;border-radius:10px;max-width:880px;white-space:pre-wrap;word-break:break-word;}
.bubble.typing::after{content:" ";display:inline-block;width:8px;height:14px;background:var(--text);margin-left:2px;animation:blink 1s steps(1) infinite;vertical-align:-2px;}
@keyframes blink{50%{opacity:0;}}

.composer{
  position:sticky;bottom:0;z-index:5;
  background:linear-gradient(0deg,rgba(15,18,23,0.95),rgba(15,18,23,0.90));
  backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);
  border-top:1px solid var(--border);
  padding:10px 16px calc(10px + var(--safe-bottom));
}
.composer .top{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:8px;}
.composer .bar{display:flex;gap:8px;align-items:flex-end;}
.composer textarea{min-height:44px;max-height:200px;flex:1 1 auto;}

button{background:var(--panel-2);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 14px;cursor:pointer;}
button.primary{background:#20324f;border-color:#315485;color:#cfe1ff;}
button.stop{background:#3a1d20;border-color:#6b272d;color:#ffc7ce;}
.muted{color:var(--muted);font-size:12px;}
.error{color:#ff6b6b;background:#3a1d20;padding:8px 12px;border-radius:6px;margin:10px 0;}
</style>
</head>

<body>
<div class="app">
  <header>
    <div class="title">Chat Streaming Demo (Fixed)</div>
    <div class="row">
      <label>API Key</label>
      <input id="apiKey" type="password" class="grow" placeholder="sk-..." />
      <button id="saveKey">ä¿å­˜</button>
    </div>
    <div class="row">
      <label>æ¨¡å‹</label>
      <select id="model">
        <option value="gpt-5">gpt-5</option>
        <option value="gpt-5-mini">gpt-5-mini</option>
        <option value="gpt-5-nano">gpt-5-nano</option>
      </select>
    </div>
    <div class="row" style="width:100%">
      <label class="muted">ç³»ç»Ÿæç¤ºè¯</label>
      <textarea id="systemPrompt" class="system-box" placeholder="ä¾‹å¦‚ï¼šä½ æ˜¯ä¸€ä¸ªåŠ©ç†ï¼Œå›ç­”è¦ç®€æ´..."></textarea>
    </div>
  </header>

  <main id="chat" class="chat"></main>

  <div class="composer">
    <div class="top">
      <span class="muted">æµå¼è¾“å‡º + å–æ¶ˆ å·²å¯ç”¨</span>
      <span id="status" class="muted"></span>
    </div>
    <div class="bar">
      <textarea id="input" class="grow" placeholder="è¾“å…¥ä½ çš„é—®é¢˜ï¼Œå›è½¦å‘é€..." rows="2"
        enterkeyhint="send" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></textarea>
      <button id="send" class="primary">å‘é€</button>
      <button id="stop" class="stop" style="display:none;">åœæ­¢ç”Ÿæˆ</button>
      <button id="clear">æ¸…ç©ºå¯¹è¯</button>
    </div>
  </div>
</div>

<script>
const el = {
  chat:document.getElementById('chat'),
  input:document.getElementById('input'),
  send:document.getElementById('send'),
  stop:document.getElementById('stop'),
  clear:document.getElementById('clear'),
  apiKey:document.getElementById('apiKey'),
  saveKey:document.getElementById('saveKey'),
  model:document.getElementById('model'),
  systemPrompt:document.getElementById('systemPrompt'),
  status:document.getElementById('status')
};

const isTouch = window.matchMedia('(pointer: coarse)').matches;

// ä¿å­˜å’ŒåŠ è½½API Key
if(el.saveKey){
  el.saveKey.addEventListener('click',()=>{
    localStorage.setItem('apiKey',el.apiKey.value);
    alert('API Key å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼');
  });
}
el.apiKey.value=localStorage.getItem('apiKey')||'';

// æ¶ˆæ¯å†å²
let messageHistory = [];

function addMessage(role,content,typing=false){
  const msg=document.createElement('div');
  msg.className='msg '+role;
  const avatar=document.createElement('div');
  avatar.className='avatar';
  avatar.textContent=role==='user'?'ğŸ‘¤':'ğŸ¤–';
  const bubble=document.createElement('div');
  bubble.className='bubble'+(typing?' typing':'');
  bubble.textContent=content;
  msg.appendChild(avatar);msg.appendChild(bubble);
  el.chat.appendChild(msg);
  el.chat.scrollTop=el.chat.scrollHeight;
  return bubble;
}

function showError(message) {
  const errorDiv = document.createElement('div');
  errorDiv.className = 'error';
  errorDiv.textContent = message;
  el.chat.appendChild(errorDiv);
  el.chat.scrollTop = el.chat.scrollHeight;
  setTimeout(() => errorDiv.remove(), 6000);
}

// æ¸…ç©ºå¯¹è¯
if(el.clear) el.clear.addEventListener('click',()=>{
  el.chat.innerHTML='';
  messageHistory = [];
  addMessage('assistant', 'å¯¹è¯å·²æ¸…ç©ºï¼Œè¯·è¾“å…¥æ‚¨çš„é—®é¢˜ã€‚');
  el.status.textContent='';
});

let controller=null;
let currentBubble=null;

el.input.addEventListener('keydown',(e)=>{
  // æ¡Œé¢ç«¯ï¼šEnter å‘é€ï¼›ç§»åŠ¨ç«¯ï¼šä¿ç•™æ¢è¡Œï¼Œç‚¹æŒ‰é’®å‘é€
  if(e.key==='Enter'&&!e.shiftKey&&!isTouch){
    e.preventDefault();
    el.send.click();
  }
});

el.send.addEventListener('click',async()=>{
  const prompt=el.input.value.trim();
  if(!prompt) return;

  // ç¦ç”¨å‘é€æŒ‰é’®ï¼Œæ˜¾ç¤ºåœæ­¢æŒ‰é’®
  el.send.disabled=true;
  el.stop.style.display='inline-block';
  el.input.disabled = true;

  try{
    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    addMessage('user',prompt);
    messageHistory.push({role: 'user', content: prompt});

    // æ¸…ç©ºè¾“å…¥æ¡†
    el.input.value = '';

    // åˆ›å»ºä¸­æ­¢æ§åˆ¶å™¨
    controller=new AbortController();

    // æ·»åŠ åŠ©æ‰‹æ¶ˆæ¯ï¼ˆæ­£åœ¨è¾“å…¥çŠ¶æ€ï¼‰
    const bubble=addMessage('assistant','',true);
    currentBubble = bubble;

    // è°ƒç”¨API
    await fetchStream(bubble,controller.signal);
  }catch(err){
    console.error(err);
    if(err.name !== 'AbortError') {
      showError('å‡ºé”™: ' + (err.message || String(err)));
    }
  } finally{
    // æ¢å¤UIçŠ¶æ€
    el.send.disabled=false;
    el.stop.style.display='none';
    el.input.disabled = false;
    if (!isTouch) el.input.focus();
    if (currentBubble) currentBubble.classList.remove('typing');
    currentBubble = null;
  }
});

// åœæ­¢ç”Ÿæˆ
el.stop.addEventListener('click',()=>{
  if(controller) controller.abort();
  if (currentBubble) {
    currentBubble.classList.remove('typing');
    currentBubble.textContent = (currentBubble.textContent || '') + 'ï¼ˆå·²åœæ­¢ï¼‰';
  }
  el.status.textContent = 'å·²åœæ­¢ç”Ÿæˆ';
});

// è·å–æµå¼å“åº”ï¼ˆå¥å£®çš„ SSE è§£æ + å–æ¶ˆå¤„ç† + å‹å¥½é”™è¯¯ï¼‰
async function fetchStream(bubble, signal) {
  const apiKey = el.apiKey.value.trim();
  if(!apiKey || !apiKey.startsWith('sk-')) {
    throw new Error('è¯·è¾“å…¥æœ‰æ•ˆçš„OpenAI API Key');
  }

  const headers = {
    'Authorization': 'Bearer ' + apiKey,
    'Content-Type': 'application/json'
  };

  const systemContent = el.systemPrompt.value || 'ä½ æ˜¯ä¸€ä¸ªåŠ©ç†ã€‚';
  const modelName = el.model.value;

  // æ„å»ºæ¶ˆæ¯å†å²ï¼ˆåŒ…å«ç³»ç»Ÿæç¤ºï¼‰
  const messages = [
    {role: 'system', content: systemContent},
    ...messageHistory
  ];

  const body = {
    model: modelName,
    messages: messages,
    stream: true
  };

  el.status.textContent = 'æ­£åœ¨è¿æ¥...';

  const response = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: headers,
    body: JSON.stringify(body),
    signal: signal
  });

  if(!response.ok) {
    let msg = `APIé”™è¯¯: ${response.status} ${response.statusText}`;
    try {
      const errJson = await response.json();
      msg = errJson.error?.message || msg;
    } catch {
      try {
        const t = await response.text();
        if (t) msg = t;
      } catch {}
    }
    throw new Error(msg);
  }

  el.status.textContent = 'å·²è¿æ¥ï¼Œå¼€å§‹æµå¼ä¼ è¾“...';

  const reader = response.body.getReader();
  const decoder = new TextDecoder('utf-8');
  let buffer = '';
  let fullText = '';

  try {
    while(true) {
      const {value, done} = await reader.read();
      if(done) break;

      buffer += decoder.decode(value, { stream: true });

      const parts = buffer.split('\n');
      buffer = parts.pop() || '';

      let hitDone = false;

      for (let raw of parts) {
        const line = raw.trim();
        if (!line || !line.startsWith('data:')) continue;

        const dataStr = line.slice(5).trim();
        if (dataStr === '[DONE]') {
          hitDone = true;
          el.status.textContent = 'å®Œæˆ';
          break;
        }

        let data;
        try {
          data = JSON.parse(dataStr);
        } catch {
          continue;
        }

        const delta = data.choices?.[0]?.delta || {};
        if (typeof delta.content === 'string') {
          fullText += delta.content;
          bubble.textContent = fullText;
          el.chat.scrollTop = el.chat.scrollHeight;
          el.status.textContent = 'æ­£åœ¨ç”Ÿæˆ...';
        }

        const finish = data.choices?.[0]?.finish_reason;
        if (finish) {
          el.status.textContent = finish === 'length' ? 'è¾¾åˆ°æœ€å¤§é•¿åº¦' : 'å®Œæˆ';
        }
      }

      if (hitDone) break;
    }

    const last = buffer.trim();
    if (last.startsWith('data:')) {
      const ds = last.slice(5).trim();
      if (ds !== '[DONE]') {
        try {
          const data = JSON.parse(ds);
          const delta = data.choices?.[0]?.delta || {};
          if (typeof delta.content === 'string') {
            fullText += delta.content;
            bubble.textContent = fullText;
          }
        } catch {}
      }
    }

  } catch (err) {
    if (err.name === 'AbortError') {
      el.status.textContent = 'å·²åœæ­¢ç”Ÿæˆ';
    } else {
      throw err;
    }
  } finally {
    try { reader.releaseLock(); } catch {}
    bubble.classList.remove('typing');
  }

  if (fullText) {
    messageHistory.push({role: 'assistant', content: fullText});
  }
}
</script>
</body>
</html>
